/**\n * AI Assistant Component\n * \n * Subscribes to real-time events from the API and generates contextual insights.\n * Features:\n * - Live anomaly detection insights\n * - Predictive maintenance recommendations\n * - Risk scoring and alerts\n * - Conversational interface with mission planning\n * \n * Production implementation would integrate with:\n * - Claude API or OpenAI for natural language\n * - Event stream from /events (SSE)\n * - Mission planning via /missions endpoints\n */\n\nimport { useEffect, useState, useCallback } from \"react\";\nimport { AlertCircle, Brain, Send, X, CheckCircle } from \"lucide-react\";\n\ninterface Insight {\n  id: string;\n  type: \"alert\" | \"recommendation\" | \"info\" | \"success\";\n  title: string;\n  description: string;\n  severity?: \"low\" | \"medium\" | \"high\";\n  timestamp: number;\n  actionable?: boolean;\n  suggestedAction?: string;\n}\n\ninterface Message {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n  timestamp: number;\n}\n\nexport function AIAssistant() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [insights, setInsights] = useState<Insight[]>([]);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [input, setInput] = useState(\"\");\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [eventSource, setEventSource] = useState<EventSource | null>(null);\n\n  /**\n   * Initialize SSE connection to /events\n   */\n  useEffect(() => {\n    const es = new EventSource(\"http://localhost:4000/events\");\n\n    es.addEventListener(\"message\", (e) => {\n      const event = JSON.parse(e.data);\n      handleIncomingEvent(event);\n    });\n\n    es.addEventListener(\"error\", () => {\n      es.close();\n    });\n\n    setEventSource(es);\n\n    return () => {\n      es.close();\n    };\n  }, []);\n\n  /**\n   * Process incoming events from the API and generate insights\n   */\n  const handleIncomingEvent = useCallback((event: any) => {\n    const now = Date.now();\n\n    if (event.type === \"anomaly.detected\") {\n      const insight: Insight = {\n        id: `insight_${now}`,\n        type: \"alert\",\n        title: \"Anomaly Detected\",\n        description: `${event.anomalyType} detected at ${event.assetId} with confidence ${(event.confidence * 100).toFixed(0)}%`,\n        severity: event.confidence > 0.9 ? \"high\" : \"medium\",\n        timestamp: now,\n        actionable: true,\n        suggestedAction:\n          event.confidence > 0.9\n            ? \"Consider immediate investigation or maintenance\"\n            : \"Monitor closely over next hour\"\n      };\n      setInsights((prev) => [insight, ...prev].slice(0, 10));\n    } else if (event.type === \"mission.completed\") {\n      const insight: Insight = {\n        id: `insight_${now}`,\n        type: \"success\",\n        title: \"Mission Completed\",\n        description: `Mission ${event.missionId} finished successfully`,\n        timestamp: now\n      };\n      setInsights((prev) => [insight, ...prev].slice(0, 10));\n    } else if (event.type === \"valve.actuated\") {\n      const insight: Insight = {\n        id: `insight_${now}`,\n        type: \"info\",\n        title: \"Valve Actuated\",\n        description: `Valve ${event.valveId} set to ${event.position} (requested by ${event.requestedBy})\",\n        timestamp: now\n      };\n      setInsights((prev) => [insight, ...prev].slice(0, 10));\n    }\n  }, []);\n\n  /**\n   * Send user message and get AI response\n   */\n  const handleSendMessage = async () => {\n    if (!input.trim()) return;\n\n    const userMsg: Message = {\n      id: `msg_${Date.now()}`,\n      role: \"user\",\n      content: input,\n      timestamp: Date.now()\n    };\n\n    setMessages((prev) => [...prev, userMsg]);\n    setInput(\"\");\n    setIsProcessing(true);\n\n    try {\n      // Mock response - in production, call Claude/OpenAI\n      const response = await generateAIResponse(input);\n\n      const assistantMsg: Message = {\n        id: `msg_${Date.now()}`,\n        role: \"assistant\",\n        content: response,\n        timestamp: Date.now()\n      };\n\n      setMessages((prev) => [...prev, assistantMsg]);\n    } catch (err) {\n      console.error(\"AI error:\", err);\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  /**\n   * Generate mock AI response\n   * In production: call Claude API or OpenAI\n   */\n  const generateAIResponse = async (userInput: string): Promise<string> => {\n    // Mock: pattern matching on common queries\n    const lower = userInput.toLowerCase();\n\n    if (lower.includes(\"status\") || lower.includes(\"health\")) {\n      return (\n        \"Current system health is strong. Flow metrics are within normal ranges, \" +\n        \"with only minor temperature fluctuations. No immediate concerns detected. \" +\n        \"Recommend routine valve inspection next week.\"\n      );\n    }\n\n    if (lower.includes(\"anomal\") || lower.includes(\"alert\")) {\n      return (\n        `I found ${insights.filter((i) => i.type === \"alert\").length} active alerts. ` +\n        \"The most recent shows a flow rate deviation in Pipeline A. \" +\n        \"Suggest checking for blockage or partial valve closure.\"\n      );\n    }\n\n    if (lower.includes(\"mission\") || lower.includes(\"plan\")) {\n      return (\n        \"I can help plan a maintenance mission. Would you like to: \" +\n        \"1) Inspect all valves, 2) Perform pressure relief sequence, \" +\n        \"or 3) Run diagnostic flow test? Let me know your preference.\"\n      );\n    }\n\n    if (lower.includes(\"help\") || lower.includes(\"?\")) {\n      return (\n        \"I can help with: system status, anomaly investigation, mission planning, \" +\n        \"maintenance recommendations, and predictive analysis. \" +\n        \"What would you like to know?\"\n      );\n    }\n\n    return (\n      \"I understand you're asking about \" +\n      userInput.slice(0, 30) +\n      \"... Can you provide more details? \" +\n      \"I can help with diagnostics, planning, and insights.\"\n    );\n  };\n\n  return (\n    <div className=\"fixed bottom-4 right-4 z-50\">\n      {/* Floating button */}\n      {!isOpen && (\n        <button\n          onClick={() => setIsOpen(true)}\n          className=\"bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition-all\"\n          title=\"Open AI Assistant\"\n        >\n          <Brain size={24} />\n        </button>\n      )}\n\n      {/* Chat window */}\n      {isOpen && (\n        <div className=\"bg-white rounded-lg shadow-2xl w-96 h-[32rem] flex flex-col border border-gray-200 dark:bg-gray-900 dark:border-gray-700\">\n          {/* Header */}\n          <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-t-lg flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <Brain size={20} />\n              <span className=\"font-semibold\">AI Assistant</span>\n            </div>\n            <button\n              onClick={() => setIsOpen(false)}\n              className=\"hover:bg-blue-800 p-1 rounded transition-colors\"\n            >\n              <X size={20} />\n            </button>\n          </div>\n\n          {/* Insights Panel */}\n          <div className=\"border-b dark:border-gray-700 px-4 py-2 max-h-24 overflow-y-auto\">\n            {insights.length > 0 && (\n              <div className=\"text-xs text-gray-600 dark:text-gray-400\">\n                <p className=\"font-semibold mb-1\">Recent Insights:</p>\n                {insights.slice(0, 2).map((insight) => (\n                  <div\n                    key={insight.id}\n                    className={`text-xs p-1 rounded mb-1 flex gap-1 ${\n                      insight.type === \"alert\"\n                        ? \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\"\n                        : insight.type === \"success\"\n                          ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\"\n                          : \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\"\n                    }`}\n                  >\n                    {insight.type === \"alert\" && <AlertCircle size={12} className=\"mt-0.5\" />}\n                    {insight.type === \"success\" && <CheckCircle size={12} className=\"mt-0.5\" />}\n                    <span>{insight.title}</span>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Messages */}\n          <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n            {messages.length === 0 && (\n              <div className=\"text-center text-gray-500 dark:text-gray-400 text-sm mt-8\">\n                <p className=\"font-semibold mb-2\">How can I help?</p>\n                <p className=\"text-xs\">Ask about system status, anomalies, or mission planning</p>\n              </div>\n            )}\n\n            {messages.map((msg) => (\n              <div\n                key={msg.id}\n                className={`flex ${msg.role === \"user\" ? \"justify-end\" : \"justify-start\"}`}\n              >\n                <div\n                  className={`max-w-xs px-3 py-2 rounded-lg text-sm ${\n                    msg.role === \"user\"\n                      ? \"bg-blue-600 text-white rounded-br-none\"\n                      : \"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-bl-none\"\n                  }`}\n                >\n                  {msg.content}\n                </div>\n              </div>\n            ))}\n\n            {isProcessing && (\n              <div className=\"flex justify-start\">\n                <div className=\"bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg\">\n                  <div className=\"flex gap-1\">\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" />\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: \"0.1s\" }} />\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: \"0.2s\" }} />\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Input */}\n          <div className=\"border-t dark:border-gray-700 p-3 flex gap-2\">\n            <input\n              type=\"text\"\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyPress={(e) => e.key === \"Enter\" && handleSendMessage()}\n              placeholder=\"Ask a question...\"\n              className=\"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              disabled={isProcessing}\n            />\n            <button\n              onClick={handleSendMessage}\n              disabled={isProcessing || !input.trim()}\n              className=\"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white p-2 rounded-lg transition-colors\"\n            >\n              <Send size={18} />\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"